# ============================================================
#  CI/CD Pipeline â€” LLM Evaluations
#  Platform : GitHub Actions
# ============================================================
#
#  PIPELINE STRUCTURE :
#  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#  â”‚ Lint &      â”‚   â”‚ Security     â”‚
#  â”‚ Format      â”‚   â”‚ Scan         â”‚
#  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#  TRIGGERS :
#    - Push on 'main' or 'develop'
#    - Pull Request targeting 'main' or 'develop'
#
# ============================================================

name: ğŸ LLM Evaluations â€” CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# Cancel previous runs on the same branch to save Actions minutes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

# ============================================================
# JOB 1 â€” LINT & FORMAT
# Checks code quality and style with Ruff (linter + formatter)
# ============================================================
jobs:
  lint:
    name: ğŸ” Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install quality tools
        run: |
          pip install --upgrade pip
          pip install ruff mypy

      - name: âœ¨ Check formatting (Ruff format)
        run: ruff format --check --diff .

      - name: ğŸ” Lint (Ruff)
        run: ruff check .

      - name: ğŸ·ï¸ Type check (Mypy)
        run: mypy . --ignore-missing-imports
        continue-on-error: true   # Non-blocking â€” no type annotations yet

# ============================================================
# JOB 2 â€” SECURITY SCAN
# Detects vulnerabilities in dependencies and source code
# ============================================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ›¡ï¸ Dependency vulnerability scan (pip-audit)
        run: |
          pip install pip-audit
          pip-audit --requirement requirements.txt

      - name: ğŸ” Static security analysis (Bandit)
        run: |
          pip install bandit[toml]
          bandit -r notebooks/ -c pyproject.toml
        continue-on-error: true   # Warning only â€” not blocking

      - name: ğŸ³ Filesystem vulnerability scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH"
          exit-code: "0"          # Set to "1" to block on findings
